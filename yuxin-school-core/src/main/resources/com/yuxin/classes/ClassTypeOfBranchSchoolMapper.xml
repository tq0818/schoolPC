<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yuxin.wx.classes.mapper.ClassTypeOfBranchSchoolMapper">
	<resultMap type="com.yuxin.wx.model.classes.ClassType" id="classTypeResultMap">
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="typeCode" column="type_code" />
		<result property="originalPrice" column="original_price" />
		<result property="realPrice" column="real_price" />
		<result property="schoolsId" column="schools_id" />
		<result property="itemOneId" column="item_one_id" />
		<result property="itemSecondId" column="item_second_id" />
		<result property="description" column="description" />
		<result property="publishStatus" column="publish_status" />
		<result property="publishTime" column="publish_time" />
		<result property="isSale" column="is_sale" />
		<result property="cover" column="cover" />
		<result property="subTitle" column="sub_title" />
		<result property="detailDesc" column="detail_desc" />
		<result property="createTime" column="create_time" />
		<result property="creator" column="creator" />
		<result property="updateTime" column="update_time" />
		<result property="updator" column="updator" />
		<result property="delFlag" column="del_flag" />
		<result property="companyId" column="company_id" />
		<result property="teacherId" column="teacher_id" />
		<result property="faceFlag" column="face_flag"/>
		<result property="liveFlag" column="live_flag"/>
		<result property="baseNum" column="base_num"/>
		<result property="videoFlag" column="video_flag"/>
		<result property="remoteFlag" column="remote_flag"/>
		<result property="recommendFlag" column="recommend_flag"/>
		<result property="createSchoolId" column="create_school_id"/>
		<result property="validityDay" column="validity_day"/>
		<result property="validityDate" column="validity_date"/>
		<result property="videoWatchCount" column="video_watch_count"/>
		<result property="liveWatchCount" column="live_watch_count"/>
		<result property="commodityId" column="commodityId"/>
		<result property="integralFlag" column="integral_flag"/>
		<result property="memberFlag" column="member_flag"/>
		<result property="buyNumMax" column="buy_num_max"/>
		<result property="protocolId" column="protocol_id"/>
		<result property="iconLable" column="icon_lable"/>
	    <result property="subjectClassOrder" column="subject_class_order"/>
		<result property="itemOneCode" column="item_one_code" />
		<result property="itemSecondCode" column="item_second_code" />
		<result property="itemThirdCode" column="item_third_code" />
		<result property="itemFourthCode" column="item_fourth_code" />
		<result property="paperDescription" column="paper_description" />
		
		<result property="isOutSource" column="is_out_source" />
		<result property="isPublic" column="is_public" />
		<result property="publicPrice" column="public_price" />
	</resultMap>
	
	<resultMap type="com.yuxin.wx.vo.classes.ClassTypeVo" id="classTypeVoResultMap">
		<result property="id" column="id" />
		<result property="commodityId" column="com_id" />
		<result property="name" column="name" />
		<result property="typeCode" column="type_code" />
		<result property="originalPrice" column="original_price" />
		<result property="realPrice" column="real_price" />
		<result property="schoolsId" column="schools_id" />
		<result property="itemOneId" column="item_one_id" />
		<result property="itemSecondId" column="item_second_id" />
		<result property="itemOneCode" column="item_one_code" />
		<result property="itemSecondCode" column="item_second_code" />
		<result property="itemOneName" column="item_one_name" />
		<result property="itemSecondName" column="item_second_name" />
		<result property="itemThirdCode" column="item_third_code" />
		<result property="itemFourthCode" column="item_fourth_code" />
		<result property="itemThirdName" column="item_third_name" />
		<result property="itemFourthName" column="item_fourthd_name" />
		<result property="description" column="description" />
		<result property="publishStatus" column="publish_status" />
		<result property="publishTime" column="publish_time" />
		<result property="isSale" column="is_sale" />
		<result property="cover" column="cover" />
		<result property="companyId" column="company_id" />
		<result property="subTitle" column="sub_title" />
		<result property="detailDesc" column="detail_desc" />
		<result property="createTime" column="create_time" />
		<result property="creator" column="creator" />
		<result property="updateTime" column="update_time" />
		<result property="updator" column="updator" />
		<result property="delFlag" column="del_flag" />
		<result property="lableType" column="lable_type" />
		<result property="baseNum" column="base_num" />
		<result property="actualNum" column="actualNum"/>
		<result property="teacherId" column="teacher_id" />
		<result property="faceFlag" column="face_flag"/>
		<result property="liveFlag" column="live_flag"/>
		<result property="videoFlag" column="video_flag"/>
		<result property="remoteFlag" column="remote_flag"/>
		<result property="recommendFlag" column="recommend_flag"/>
		<result property="createSchoolId" column="create_school_id"/>
		<result property="itemTag" column="item_tag"/>
		<result property="validityDay" column="validity_day"/>
		<result property="validityDate" column="validity_date"/>
		<result property="videoWatchCount" column="video_watch_count"/>
		<result property="liveWatchCount" column="live_watch_count"/>
		<result property="relationId" column="relationId"/>
		<result property="integralFlag" column="integral_flag"/>
		<result property="memberFlag" column="member_flag"/>
		<result property="buyNumMax" column="buy_num_max"/>
		<result property="protocolId" column="protocol_id"/>
		<result property="iconLable" column="icon_lable"/>
		<result property="subjectClassOrder" column="subject_class_order"/>
		<result property="isMicroClass" column="is_micro_class"/>
		<result property="paperDescription" column="paper_description" />
		
		<result property="isOutSource" column="is_out_source" />
		<result property="isPublic" column="is_public" />
		<result property="publicPrice" column="public_price" />
		
		<result property="schoolName" column="school_name"/>
		<result property="teacherName" column="teacher_name"/>
		<result property="domain" column="domain"/>
		<result property="cddsStatus" column="cdds_status"/>
		<result property="cddsRecommendFlag" column="cdds_recommend_flag"/>
		
	</resultMap>
	
	<resultMap type="com.yuxin.wx.model.system.SysConfigItemRelation" id="sysConfigItemRelationResultMap">
        <result property="id" column="id" />
        <result property="itemCode" column="item_code" />
        <result property="parentCode" column="parent_code" />
        <result property="parentId" column="parent_id" />
        <result property="level" column="level" />
        <result property="levelPath" column="level_path" />
        <result property="isParent" column="is_parent" />
        <result property="itemName" column="item_name" />
    </resultMap>
    
    <resultMap type="com.yuxin.wx.model.classes.ClassModule" id="classModuleResultMap">
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="itemOneId" column="item_one_id" />
		<result property="itemSecondId" column="item_second_id" />
		<result property="totalClassHour" column="total_class_hour" />
		<result property="teachMethod" column="teach_method" />
		<result property="moduleType" column="module_type" />
		<result property="moduleDesc" column="module_desc" />
		<result property="schoolId" column="school_id" />
		<result property="publishStatus" column="publish_status" />
		<result property="publishTime" column="publish_time" />
		<result property="delFlag" column="del_flag" />
		<result property="createTime" column="create_time" />
		<result property="creator" column="creator" />
		<result property="updateTime" column="update_time" />
		<result property="updator" column="updator" />
		<result property="companyId" column="company_id" />
		<result property="chapterFlag" column="chapter_flag"/>
		<result property="liveType" column="live_type"/>
	</resultMap>
    
    <resultMap type="com.yuxin.wx.model.course.CourseVideoChapter" id="courseVideoChapterResultMap">
		<result property="id" column="id" />
		<result property="chapterName" column="chapter_name" />
		<result property="moduleId" column="module_id" />
		<result property="chapterOrder" column="chapter_order" />
	</resultMap>
	
	<resultMap type="com.yuxin.wx.model.course.CourseRemote" id="courseRemoteResultMap">
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="major" column="major" />
		<result property="itemOneId" column="item_one_id" />
		<result property="itemSecondId" column="item_second_id" />
		<result property="schoolId" column="school_id" />
		<result property="status" column="status" />
		<result property="createTime" column="create_time" />
		<result property="creator" column="creator" />
		<result property="updateTime" column="update_time" />
		<result property="updator" column="updator" />
		<result property="delFlag" column="del_flag" />
		<result property="companyId" column="company_id" />
	</resultMap>
    
    <resultMap type="com.yuxin.wx.model.classes.ClassTypeResource" id="classTypeResourceResultMap">
		<result property="id" column="id" />
		<result property="itemOneId" column="item_one_id" />
		<result property="itemSecondId" column="item_second_id" />
		<result property="classTypeId" column="class_type_id" />
		<result property="classTypeName" column="class_type_name" />
		<result property="lectureId" column="lecture_id" />
		<result property="resourceType" column="resource_type" />
		<result property="companyId" column="company_id" />
		<result property="lectureType" column="lecture_type"/>
		<result property="fileId" column="file_id"/>
	</resultMap>
    
    <resultMap type="com.yuxin.wx.vo.classes.ClassTypeResourceVo" 
	 extends="classTypeResourceResultMap" id="classTypeResourceResultVoMap">
		<result property="name" column="name"/>
		<result property="fileSize" column="file_size"/>
		<result property="uploadTime" column="upload_time"/>
		<result property="uploader" column="upload_user_name"></result>
		<result property="sourceSize" column="source_size"></result>
		<result property="oldData" column="old_data"></result>
	</resultMap>
    
    <resultMap type="com.yuxin.wx.model.commodity.Commodity" id="commodityResultMap">
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="coverUrl" column="cover_url" />
		<result property="overview" column="overview" />
		<result property="originalPrice" column="original_price" />
		<result property="realPrice" column="real_price" />
		<result property="type" column="type" />
		<result property="itemOneId" column="item_one_id" />
		<result property="itemSecondId" column="item_second_id" />
		<result property="schoolId" column="school_id" />
		<result property="companyId" column="company_id" />
		<result property="creator" column="creator" />
		<result property="cerateTime" column="cerate_time" />
		<result property="updator" column="updator" />
		<result property="updateTime" column="update_time" />
		<result property="status" column="status" />
		<result property="lableType" column="lable_type" />
		<result property="baseNum" column="base_num" />
		<result property="faceFlag" column="face_flag" />
		<result property="liveFlag" column="live_flag" />
		<result property="videoFlag" column="video_flag" />
		<result property="remoteFlag" column="remote_flag" />
		<result property="recommendFlag" column="recommend_flag" />
		<result property="buyNum" column="buy_num" />
		<result property="itemTag" column="item_tag"/>
		<result property="integralFlag" column="integral_flag"/>
		<result property="memberFlag" column="member_flag"/>
		<result property="itemOneCode" column="item_one_code" />
		<result property="itemSecondCode" column="item_second_code" />
		<result property="itemThirdCode" column="item_third_code" />
		<result property="itemFourthCode" column="item_fourth_code" />
		<result property="isMicroClass" column="is_micro_class" />
	</resultMap>
    
    <resultMap type="com.yuxin.wx.vo.course.CourseExerciseVo" id="courseExerciseVoResultMap">
		<result property="id" column="id" />
		<result property="classTypeId" column="class_type_id" />
		<result property="resourceType" column="resource_type" />
		<result property="resourceId" column="resource_id" />
		<result property="exerciseType" column="exercise_type" />
		<result property="tikuResourceType" column="tiku_resource_type" />
		<result property="tikuCategoryId" column="tiku_category_id" />
		<result property="tikuSubjectId" column="tiku_subject_id" />
		<result property="tikuChapterId" column="tiku_chapter_id" />
		<result property="tikuSectionId" column="tiku_section_id" />
		<result property="topicNum" column="topic_num" />
		<result property="paperId" column="paper_id" />
		<result property="companyId" column="company_id" />
		<result property="subjectName" column="subject_name" />
	</resultMap>
    
    <resultMap type="com.yuxin.wx.model.tiku.TikuTopic" id="tikuTopicResultMap">
		<result property="id" column="id" />
		<result property="topicName" column="topic_name" />
		<result property="topicNameBlank" column="topic_name_blank" />
		<result property="topicType" column="topic_type" />
		<result property="score" column="score" />
		<result property="answer" column="answer" />
		<result property="difficulty" column="difficulty" />
		<result property="analyseWord" column="analyse_word" />
		<result property="analyseVideoUrl" column="analyse_video_url" />
		<result property="analyseAudioUrl" column="analyse_audio_url" />
		<result property="parentId" column="parent_id" />
		<result property="status" column="status" />
		<result property="tikuSubjectId" column="tiku_subject_id" />
		<result property="tikuCategoryId" column="tiku_category_id" />
		<result property="companyId" column="company_id" />
		<result property="creator" column="creator" />
		<result property="createTime" column="create_time" />
		<result property="updator" column="updator" />
		<result property="updateTime" column="update_time" />
		<result property="auditor" column="auditor" />
		<result property="auditTime" column="audit_time" />
		<result property="paperFlag" column="paper_flag" />
		<result property="childFlag" column="child_flag" />
		<result property="correctFlag" column="correct_flag" />
	</resultMap>
    
	<sql id="table_columns">
		id,
		name,
		type_code,
		original_price,
		real_price,
		schools_id,
		item_one_id,
		item_second_id,
		description,
		publish_status,
		publish_time,
		is_sale,
		cover,
		sub_title,
		detail_desc,
		create_time,
		creator,
		update_time,
		updator,
		del_flag,
		company_id,
		lable_type,
		base_num,
		teacher_id,
		face_flag,
		live_flag,
		video_flag,
		remote_flag,
		recommend_flag,
		create_school_id,
		item_tag,
		validity_day,
		validity_date,
		video_watch_count,
		live_watch_count,
		integral_flag,
		member_flag,
		buy_num_max,
		protocol_id,
		icon_lable,
		item_one_code,
		item_second_code,
		item_third_code,
		item_fourth_code,
		is_micro_class,
		paper_description,
		is_out_source,
		is_public,
		public_price
    </sql>

	<sql id="entity_properties">
		#{id},
		#{name},
		#{typeCode},
		#{originalPrice},
		#{realPrice},
		#{schoolsId},
		#{itemOneId},
		#{itemSecondId},
		#{description},
		#{publishStatus},
		#{publishTime},
		#{isSale},
		#{cover},
		#{subTitle},
		#{detailDesc},
		#{createTime},
		#{creator},
		#{updateTime},
		#{updator},
		#{delFlag},
		#{companyId},
		#{lableType},
		#{baseNum},
		#{teacherId},
		#{faceFlag},
		#{liveFlag},
		#{videoFlag},
		#{remoteFlag},
		#{recommendFlag},
		#{createSchoolId},
		#{itemTag},
		#{validityDay},
		#{validityDate},
		#{videoWatchCount},
		#{liveWatchCount},
		#{integralFlag},
		#{memberFlag},
		#{buyNumMax},
		#{protocolId},
		#{iconLable},
		#{itemOneCode},
		#{itemSecondCode},
		#{itemThirdCode},
		#{itemFourthCode},
		#{isMicroClass},
		#{paperDescription},
		#{isOutSource},
		#{isPublic},
		#{publicPrice}
	</sql>
	
	<sql id="batch_entity_properties">
		#{item.id},
		#{item.name},
		#{item.typeCode},
		#{item.originalPrice},
		#{item.realPrice},
		#{item.schoolsId},
		#{item.itemOneId},
		#{item.itemSecondId},
		#{item.description},
		#{item.publishStatus},
		#{item.publishTime},
		#{item.isSale},
		#{item.cover},
		#{item.subTitle},
		#{item.detailDesc},
		#{item.createTime},
		#{item.creator},
		#{item.updateTime},
		#{item.updator},
		#{item.delFlag},
		#{item.companyId},
		#{item.lableType},
		#{item.baseNum},
		#{item.teacherId},
		#{item.faceFlag},
		#{item.liveFlag},
		#{item.videoFlag},
		#{item.remoteFlag},
		#{item.recommendFlag},
		#{item.createSchoolId},
		#{item.itemTag},
		#{item.validityDay},
		#{item.validityDate},
		#{item.videoWatchCount},
		#{item.liveWatchCount},
		#{item.integralFlag},
		#{item.memberFlag},
		#{item.buyNumMax},
		#{item.protocolId},
		#{item.iconLable},
		#{item.itemOneCode},
		#{item.itemSecondCode},
		#{item.itemThirdCode},
		#{item.itemFourthCode},
		#{item.isMicroClass},
		#{item.paperDescription},
		#{item.isPublic},
		#{item.publicPrice}
	</sql>
	
	<select id="queryClassTypeOfBranchSchool" parameterType="map" resultMap="classTypeVoResultMap">
		SELECT ct.id,ct.name,c1.company_name as school_name,sci1.item_name as item_one_name,
			   ct.face_flag,ct.live_flag,ct.video_flag,ct.remote_flag,ct.recommend_flag,
			   sci2.item_name as item_second_name,sci3.item_name as item_third_name, c.cdds_status,ct.create_time
		from class_type ct
		join commodity_product_realtion pr on pr.product_id=ct.id
		JOIN commodity c on c.id=pr.com_id and c.origin_type=0
		JOIN company c1 on c1.id=ct.company_id and c1.is_area=2
		<if test="areaId != null and areaId != ''">
			JOIN sys_config_dict sd on sd.item_code=c1.edu_area_school and sd.parent_item_id=#{areaId}
		</if>
		LEFT JOIN sys_config_item sci1 on sci1.item_code=ct.item_one_code and sci1.company_id=ct.company_id
		LEFT JOIN sys_config_item sci2 on sci2.item_code=ct.item_second_code and sci2.company_id=ct.company_id
		LEFT JOIN sys_config_item sci3 on sci3.item_code=ct.item_third_code and sci3.company_id=ct.company_id
		where ct.origin_type=0 and ct.is_public=1 and  ct.publish_status='CLASS_ON_SALE'
			  and ct.is_out_source=0	
			<if test="schoolCode != null and schoolCode != ''">
				and c1.edu_area_school=#{schoolCode}
			</if>
			<if test="firstItemCode != null and firstItemCode != ''">
				and ct.item_one_code=#{firstItemCode}
			</if>
			<if test="secondItemCode != null and secondItemCode != ''">
				and ct.item_second_code=#{secondItemCode}
			</if>
			<if test="thirdItemCode != null and thirdItemCode != ''">
				and ct.item_third_code=#{thirdItemCode}
			</if>
			<if test="name != null and name != ''">
				and ct.name like '%${name}%'
			</if>
			<if test="cddsStatus != null and cddsStatus != ''">
				and c.cdds_status=#{cddsStatus}
			</if>
			<if test="startTime != null and startTime != ''">
				<![CDATA[and ct.create_time >= #{startTime} ]]>
			</if>
			<if test="endTime != null and endTime != ''">
				<![CDATA[and ct.create_time <=#{endTime} ]]>
			</if>
			ORDER BY ct.create_time desc
			limit #{firstIndex},#{pageSize}
	</select>
	<select id="queryCountClassTypeOfBranchSchool" resultType="int" parameterType="map">
		SELECT count(ct.id)	from class_type ct
		join commodity_product_realtion pr on pr.product_id=ct.id
		JOIN commodity c on c.id=pr.com_id and c.origin_type=0
		JOIN company c1 on c1.id=ct.company_id and c1.is_area=2
		<if test="areaId != null and areaId != ''">
			JOIN sys_config_dict sd on sd.item_code=c1.edu_area_school and sd.parent_item_id=#{areaId}
		</if>
		where ct.origin_type=0 and ct.is_public=1 and  ct.publish_status='CLASS_ON_SALE'
			   and ct.is_out_source=0	
			<if test="schoolCode != null and schoolCode != ''">
				and c1.edu_area_school=#{schoolCode}
			</if>
			<if test="firstItemCode != null and firstItemCode != ''">
				and ct.item_one_code=#{firstItemCode}
			</if>
			<if test="secondItemCode != null and secondItemCode != ''">
				and ct.item_second_code=#{secondItemCode}
			</if>
			<if test="thirdItemCode != null and thirdItemCode != ''">
				and ct.item_third_code=#{thirdItemCode}
			</if>
			<if test="name != null and name != ''">
				and ct.name like '%${name}%'
			</if>
			<if test="cddsStatus != null and cddsStatus != ''">
				and c.cdds_status=#{cddsStatus}
			</if>
			<if test="startTime != null and startTime != ''">
				<![CDATA[and ct.create_time >= #{startTime} ]]>
			</if>
			<if test="endTime != null and endTime != ''">
				<![CDATA[and ct.create_time <=#{endTime} ]]>
			</if>
	</select>
	
	<select id="findItemFront" resultMap="sysConfigItemRelationResultMap" parameterType="map">
        select  f.id, f.item_code,i.item_name 
        from sys_config_item_relation_front f
		join sys_config_item i on i.item_code=f.item_code and i.company_id=f.company_id
		join sys_school_item_relation r on i.id=r.item_id
		join company c on c.id=i.company_id
		where f.level = #{level} and f.origin_type=0 
			and r.del_flag=0 and i.status = 1 and i.parent_code=#{parentCode}
			<if test="schoolCode != null and schoolCode != ''">
				and c.edu_area_school=#{schoolCode}
			</if>
			<if test="companyId != null">
				and c.id=#{companyId}
			</if>
			<if test="parentId != null and parentId != ''">
				and f.parent_id=#{parentId}
			</if>
    </select>
    <update id="battchUpOrDown" parameterType="Map">
   	 	update commodity set cdds_status=#{type} 
		where id in (
			SELECT p.com_id from class_type ct,commodity_product_realtion p
			where ct.id=p.product_id and ct.id in 
	    	<foreach item="item" collection="cids" open="(" separator="," close=")">
				#{item}
			</foreach>
		)
    </update>
    
    <select id="findDetailById" resultMap="classTypeVoResultMap" parameterType="map" >
		SELECT a.*, b.item_name AS itemOneName, c.item_name AS itemSecondName, 
			d.item_name AS itemThirdName, a.item_fourth_code AS itemFourthName,
			com.cdds_recommend_flag as cddsRecommendFlag,t.name as teacherName
		FROM class_type a
		join commodity_product_realtion pr on pr.product_id=a.id
		JOIN commodity com on com.id=pr.com_id and com.origin_type=0
		LEFT JOIN sys_config_teacher t on t.id=a.teacher_id
		LEFT JOIN sys_config_item b on a.item_one_code = b.item_code  and a.company_id=b.company_id
		LEFT JOIN sys_config_item c on c.item_code = a.item_second_code  and a.company_id=c.company_id
		LEFT JOIN sys_config_item d on d.item_code = a.item_third_code and a.company_id=d.company_id
		where a.id = #{classId} and a.origin_type=0
	</select>
	
	<select id="findDetailById1" resultMap="classTypeVoResultMap" parameterType="map" >
		SELECT a.*, b.item_name AS itemOneName, c.item_name AS itemSecondName, 
			d.item_name AS itemThirdName, a.item_fourth_code AS itemFourthName,
			t.name as teacherName, c1.company_name as schoolName
		FROM class_type a
		join school_share_class_type st on st.target_class_type_id=a.id
		join company c1 on c1.id=st.source_company_id 
		join class_type ct on ct.id=st.source_class_type_id
		LEFT JOIN sys_config_teacher t on t.id=a.teacher_id
		LEFT JOIN sys_config_item b on b.item_code = ct.item_one_code and ct.company_id=b.company_id
		LEFT JOIN sys_config_item c on c.item_code = ct.item_second_code and ct.company_id=c.company_id
		LEFT JOIN sys_config_item d on d.item_code = ct.item_third_code and ct.company_id=d.company_id
		where a.is_out_source=1 and a.origin_type=0 and a.id = #{classId} 
	</select>
	
	<select id="findListByClassId" resultMap="classModuleResultMap"	parameterType="map">
		select distinct m.*
		from class_type as t,class_type_module_relation as r,class_module as m
		where t.origin_type=0 and t.id=r.class_type_id and r.module_id=m.id and t.id=#{classId}
	</select>
    
    <select id="findByClassId" parameterType="map" resultMap="courseVideoChapterResultMap">
		select distinct d.* 
		from class_type a,class_type_module_relation b,	class_module c,	course_video_chapter d
		where	a.id=b.class_type_id  
			and a.origin_type=0	
			and	b.module_id=c.id
			and	c.id=d.module_id 
			and	a.id=#{classId}
	</select>
    
    <!-- 根据班型id获取绑定远程教育 -->
	<select id="findRemotesByClassTypeId" resultMap="courseRemoteResultMap" parameterType="map" >
		SELECT	distinct r.id,r.NAME,r.major,r.status
		FROM
			course_remote r,class_type c,class_type_remote_relation cmr
		WHERE	c.id = #{classId}  and c.origin_type=0
			AND r.id = cmr.remote_id
			AND c.id = cmr.class_type_id
		order by r.id DESC
	</select>
	
	<update id="setCddsRecommendFlag" parameterType="Map">
   	 	update commodity set cdds_recommend_flag=#{flag} 
		where id in (
			SELECT p.com_id from class_type ct,commodity_product_realtion p
			where ct.id=p.product_id and ct.id =#{classTypeId}
		)
    </update>
    
    <update id="setSaleOrNoSale" parameterType="Map">
   	 	update commodity set cdds_status=#{cddsStatus} 
		where id in (
			SELECT p.com_id from class_type ct,commodity_product_realtion p
			where ct.id=p.product_id and ct.id =#{id}
		)
    </update>
    
    <!-- 其他自定义SQL -->
	<select id="findResBy" parameterType="com.yuxin.wx.model.classes.ClassTypeResource" resultMap="classTypeResourceResultVoMap">
		select r.id,
			r.item_one_id,
			r.item_second_id,
			r.class_type_id,
			r.class_type_name,
			r.lecture_id,
			r.resource_type,
			r.company_id,
			r.lecture_type,
			r.file_id,
			rl.file_name name,
			rl.file_size,
			rl.upload_time,
			rl.upload_user_name,
			rl.source_size,
			rl.old_data
		from class_type_resource r
		inner join resource_list rl on rl.id = r.file_id and rl.origin_type=0 
		where 
			r.class_type_id = #{classTypeId} and 
			r.lecture_type is null and
			r.resource_type is not null and 
			r.resource_type != '' and 	rl.del_flag = 0
			<if test="resourceType != null and resourceType != ''"> and r.resource_type = #{resourceType}</if>
			order by r.id desc
		limit #{firstIndex},#{pageSize}
	</select>
	<select id="findResCountBy" parameterType="com.yuxin.wx.model.classes.ClassTypeResource" resultType="Integer">
		select count(r.id)
		from class_type_resource r
		inner join resource_list rl 
			on rl.id = r.file_id and rl.origin_type=0 
		where 
			r.class_type_id = #{classTypeId} and 
			r.lecture_type is null and
			r.resource_type is not null and 
			r.resource_type != '' and rl.del_flag = 0 
			<if test="resourceType != null and resourceType != ''"> and r.resource_type = #{resourceType}</if>
	</select>
	
		<!-- 适用于主键自增类型 -->
	<insert id="insertClassType" parameterType="com.yuxin.wx.model.classes.ClassType" useGeneratedKeys="true" keyProperty="id">
		insert into class_type( <include refid="table_columns" /> ) 
		values ( <include refid="entity_properties" /> )
	</insert>
	
	<select id="findCommodityByClassTypeId"  parameterType="Integer"  resultMap="commodityResultMap">
		SELECT c.* from commodity c,commodity_product_realtion p
		where c.id=p.com_id and p.product_id=#{classTypeId} and c.origin_type=0
	</select>
	
	<insert id="insertCommodity" parameterType="com.yuxin.wx.model.commodity.Commodity" useGeneratedKeys="true" keyProperty="id">
		INSERT into commodity (id,name,cover_url,overview,original_price,real_price,type,item_one_id,item_second_id,school_id,company_id,creator,cerate_time,
			updator,update_time,status,lable_type,base_num,face_flag,live_flag,video_flag,remote_flag,recommend_flag,buy_num,item_tag,integral_flag,member_flag,
			item_one_code,item_second_code,item_third_code,item_fourth_code,is_micro_class)
		values(#{id},#{name},#{coverUrl},#{overview},#{originalPrice},#{realPrice},#{type},#{itemOneId},#{itemSecondId},#{schoolId},#{companyId},#{creator},#{cerateTime},
			#{updator},#{updateTime},#{status},#{lableType},#{baseNum},#{faceFlag},#{liveFlag},#{videoFlag},#{remoteFlag},#{recommendFlag},#{buyNum},#{itemTag},
			#{integralFlag},#{memberFlag},#{itemOneCode},#{itemSecondCode},#{itemThirdCode},#{itemFourthCode},#{isMicroClass})
	</insert>
	
	<select id="queryResourcesByClassTypeId"  parameterType="Integer"  resultMap="classTypeResourceResultMap">
			SELECT * from class_type_resource where class_type_id=#{classTypeId} 
	</select>
	
	<insert id="insertResourceList" parameterType="com.yuxin.wx.model.resource.ResourceList" useGeneratedKeys="true" keyProperty="id">
		insert into resource_list(id,file_name,file_type,file_path,file_size,upload_time,upload_user_id,del_flag,uuid,company_id,
			file_category,del_time,sys_item_one,sys_item_second,school_id,tag,source_path,source_size,upload_user_name,updator,update_time,
			upload_type,old_data,upload_front_id,origin_type)
		SELECT null,file_name,file_type,file_path,file_size,upload_time,upload_user_id,del_flag,uuid,#{companyId},
			file_category,del_time,#{sysItemOne},#{sysItemSecond},#{schoolId},tag,source_path,source_size,upload_user_name,updator,update_time,
			upload_type,old_data,upload_front_id,origin_type 
		from resource_list 	where id=#{id}
	</insert>
	
	<insert id="insertClassTypeResource" parameterType="com.yuxin.wx.model.classes.ClassTypeResource" useGeneratedKeys="true" keyProperty="id">
		INSERT into class_type_resource (id,item_one_id,item_second_id,class_type_id,class_type_name,lecture_id,resource_type,company_id,lecture_type,file_id,
			name,size,url,uploader,upload_time,download_count,del_flag,del_time,updator,update_time)
		SELECT null,#{itemOneId},#{itemSecondId},#{classTypeId},class_type_name,lecture_id,resource_type,#{companyId},lecture_type,#{fileId},
			name,size,url,uploader,upload_time,download_count,del_flag,del_time,updator,update_time from class_type_resource
		where id=#{id}
	</insert>
	
	<select id="findCourseExercise" parameterType="Map" resultMap="courseExerciseVoResultMap">
			SELECT c.*,s.subject_name FROM course_exercise c
			LEFT JOIN tiku_subject s on c.tiku_subject_id=s.id
			where c.class_type_id=#{classId} and c.resource_id=#{resourceId}
	</select>
	
	<select id="findTikuByComIdAndTName" parameterType="com.yuxin.wx.model.tiku.TikuCategory" resultType="Integer">
		select id from tiku_category where company_id = #{companyId} and origin_type=0  and tiku_name = #{tikuName} limit 1
	</select>
	
	<select id="findTikuSubjectByCIdAndTName" parameterType="com.yuxin.wx.model.tiku.TikuSubject" resultType="Integer">
		SELECT id from tiku_subject where category_id=#{categoryId} and subject_name=#{subjectName} limit 1
	</select>
	
	<insert id="insertTikuPaperTopicType" parameterType="map" useGeneratedKeys="true">
		insert into tiku_paper_topic_type (paper_id,topic_type,score_per_topic)
		SELECT #{paperId},topic_type,score_per_topic from tiku_paper_topic_type
		where paper_id=#{sourcePaperId}
	</insert>
	
	<select id="findTopicsByPaperId" parameterType="Integer" resultMap="tikuTopicResultMap">
		SELECT t.* from tiku_topic t , tiku_paper_topic p 
		where p.topic_id=t.id and p.paper_id=#{paperId} ORDER BY p.id asc
	</select>
	
	<insert id="insertTikuTopicOption" parameterType="map" useGeneratedKeys="true">
		INSERT into tiku_topic_option(topic_id,option_no,option_name,correct_flag)
		SELECT #{topicId},option_no,option_name,correct_flag 
		from tiku_topic_option where topic_id=#{sourceTopicId}
	</insert>
	
	<insert id="insertTikuPaperTopic" parameterType="map" useGeneratedKeys="true">
		insert INTO tiku_paper_topic(paper_id,topic_id,topic_type,parent_id,topic_score)
		SELECT #{parperId},#{topicId},topic_type,parent_id,topic_score
		from tiku_paper_topic where paper_id=#{sourceParperId} and topic_id=#{sourceTopicId}
	</insert>
	
	<insert id="insertSchoolShareClassType" parameterType="com.yuxin.wx.model.classes.SchoolShareClassType" useGeneratedKeys="true" keyProperty="id">
		insert into school_share_class_type(id,source_company_id,source_class_type_id,target_company_id,target_class_type_id,is_used)
		VALUES(null,#{sourceCompanyId},#{sourceClassTypeId},#{targetCompanyId},#{targetClassTypeId},#{isUsed})
	</insert>
	
	<update id="updateClassTypeResource" >
		update  class_type_resource set lecture_id=#{0} where lecture_id=#{1} and class_type_id=#{2}
	</update>
	
	<select id="findSchoolShareClassType" parameterType="map" resultType="Integer">
			SELECT count(id) from school_share_class_type
			where target_company_id=#{targetCompanyId} and source_class_type_id=#{sourceClassTypeId} and is_used=1	
	</select>
	
	
	<select id="queryClassTypeOfOtherSchool" parameterType="map" resultMap="classTypeVoResultMap">
		SELECT ct.id,ct.name,c1.company_name as school_name,sci1.item_name as item_one_name,
		sci2.item_name as item_second_name,sci3.item_name as item_third_name,ct.create_time,ct.publish_status
		from class_type ct
		JOIN school_share_class_type st on st.target_class_type_id=ct.id and st.is_used=1
		join company c1 on c1.id=st.source_company_id
		LEFT JOIN sys_config_item sci1 on sci1.item_code=ct.item_one_code and sci1.company_id=ct.company_id
		LEFT JOIN sys_config_item sci2 on sci2.item_code=ct.item_second_code and sci2.company_id=ct.company_id
		LEFT JOIN sys_config_item sci3 on sci3.item_code=ct.item_third_code and sci3.company_id=ct.company_id
		where ct.origin_type=0 and ct.is_out_source=1 	
			<if test="companyId != null">
				and ct.company_id=#{companyId}
			</if>
			<if test="firstItemCode != null and firstItemCode != ''">
				and ct.item_one_code=#{firstItemCode}
			</if>
			<if test="secondItemCode != null and secondItemCode != ''">
				and ct.item_second_code=#{secondItemCode}
			</if>
			<if test="thirdItemCode != null and thirdItemCode != ''">
				and ct.item_third_code=#{thirdItemCode}
			</if>
			<if test="name != null and name != ''">
				and ct.name like '%${name}%'
			</if>
			<if test="status != null and status != ''">
				and ct.publish_status=#{status}
			</if>
			<if test="startTime != null and startTime != ''">
				<![CDATA[and ct.create_time >= #{startTime} ]]>
			</if>
			<if test="endTime != null and endTime != ''">
				<![CDATA[and ct.create_time <=#{endTime} ]]>
			</if>
			ORDER BY ct.create_time desc
			limit #{firstIndex},#{pageSize}
	</select>
	<select id="queryCountClassTypeOfOtherSchool" resultType="int" parameterType="map">
		SELECT count(ct.id)	from class_type ct
		where ct.origin_type=0 and ct.is_out_source=1 	
			<if test="companyId != null">
				and ct.company_id=#{companyId}
			</if>
			<if test="firstItemCode != null and firstItemCode != ''">
				and ct.item_one_code=#{firstItemCode}
			</if>
			<if test="secondItemCode != null and secondItemCode != ''">
				and ct.item_second_code=#{secondItemCode}
			</if>
			<if test="thirdItemCode != null and thirdItemCode != ''">
				and ct.item_third_code=#{thirdItemCode}
			</if>
			<if test="name != null and name != ''">
				and ct.name like '%${name}%'
			</if>
			<if test="status != null and status != ''">
				and ct.publish_status=#{status}
			</if>
			<if test="startTime != null and startTime != ''">
				<![CDATA[and ct.create_time >= #{startTime} ]]>
			</if>
			<if test="endTime != null and endTime != ''">
				<![CDATA[and ct.create_time <=#{endTime} ]]>
			</if>
	</select>
	
	 <update id="battchSaleOrNoOfCommodity" parameterType="Map">
   	 	update  commodity set updator = #{updator}, update_time = now(), status = #{status}
		where id in (
			SELECT p.com_id from class_type ct,commodity_product_realtion p
			where ct.id=p.product_id and ct.id in 
	    	<foreach item="item" collection="cids" open="(" separator="," close=")">
				#{item}
			</foreach>
		)
    </update>
    <update id="battchSaleOrNoOfClassType" parameterType="Map">
   	 	update class_type set publish_status = #{publishStatus},
		    <if test="publishStatus == 'CLASS_STOP_SALE'">subject_class_order = null,</if>
		     is_sale = #{isSale}, update_time =now(), updator = #{updator}
   	 	WHERE  id in (
	    	<foreach item="item" collection="cids" separator=",">
				#{item}
			</foreach>
		)
    </update>
	
</mapper>